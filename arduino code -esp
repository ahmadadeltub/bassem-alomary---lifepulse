#include <WiFi.h>
#include <WebServer.h>

// ---------- Wi-Fi Settings ----------
const char* WIFI_SSID = "Ahmad";
const char* WIFI_PASS = "Tub01234";

// ---------- AD8232 Pins ----------
static const int ECG_PIN   = 36;  // VP = GPIO36 (ADC1)
static const int LO_PLUS   = 12;  // change to 27 if boot issues
static const int LO_MINUS  = 13;

// ---------- Sampling ----------
static const uint16_t SAMPLE_HZ = 250;            // ECG sampling rate
static const uint32_t SAMPLE_US = 1000000UL / SAMPLE_HZ;

// Latest values shared with web page
volatile uint16_t g_ecgRaw = 0;   // 0..4095
volatile bool     g_leadsOff = false;

WebServer server(80);

// Simple HTML page that fetches /data many times per second
const char INDEX_HTML[] PROGMEM = R"HTML(
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 ECG Test</title>
  <style>
    body{font-family:Arial, sans-serif; margin:16px;}
    .box{padding:12px; border:1px solid #ddd; border-radius:12px; max-width:520px;}
    .row{display:flex; justify-content:space-between; margin:8px 0;}
    .bad{color:#b00020; font-weight:bold;}
    .ok{color:#0b7a0b; font-weight:bold;}
    code{background:#f6f6f6; padding:2px 6px; border-radius:6px;}
  </style>
</head>
<body>
  <h2>ESP32 + AD8232 ECG Live Test</h2>
  <div class="box">
    <div class="row"><div>Status:</div><div id="st">...</div></div>
    <div class="row"><div>ECG raw (0..4095):</div><div><code id="v">0</code></div></div>
    <div class="row"><div>Tip:</div><div>Open Serial Monitor for debug</div></div>
  </div>

<script>
async function poll(){
  try{
    const r = await fetch('/data');
    const j = await r.json();
    document.getElementById('v').textContent = j.ecg;
    const st = document.getElementById('st');
    if(j.leadsOff){
      st.textContent = "LEADS OFF";
      st.className = "bad";
    } else {
      st.textContent = "OK";
      st.className = "ok";
    }
  }catch(e){}
  requestAnimationFrame(poll);
}
poll();
</script>
</body>
</html>
)HTML";

void handleRoot() {
  server.send(200, "text/html", INDEX_HTML);
}

void handleData() {
  // Copy volatile to local quickly
  uint16_t v = g_ecgRaw;
  bool off = g_leadsOff;

  String json = "{";
  json += "\"ecg\":" + String(v) + ",";
  json += "\"leadsOff\":" + String(off ? "true" : "false");
  json += "}";
  server.send(200, "application/json", json);
}

bool connectWiFi(uint32_t timeoutMs = 15000) {
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASS);

  Serial.print("Connecting to Wi-Fi");
  uint32_t start = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - start < timeoutMs) {
    delay(300);
    Serial.print(".");
  }
  Serial.println();

  if (WiFi.status() == WL_CONNECTED) {
    Serial.print("Wi-Fi connected. IP: ");
    Serial.println(WiFi.localIP());
    return true;
  }

  Serial.println("Wi-Fi connection failed.");
  return false;
}

void setup() {
  Serial.begin(115200);

  pinMode(LO_PLUS, INPUT);
  pinMode(LO_MINUS, INPUT);

  // Set ADC resolution (ESP32 default is 12-bit: 0..4095)
  analogReadResolution(12);

  // Connect Wi-Fi
  connectWiFi();

  // Web server endpoints
  server.on("/", handleRoot);
  server.on("/data", handleData);
  server.begin();
  Serial.println("Web server started. Open the IP in your browser.");
}

void loop() {
  // Handle web requests
  server.handleClient();

  // ECG sampling loop (non-blocking timing)
  static uint32_t lastUs = 0;
  uint32_t nowUs = micros();
  if (nowUs - lastUs >= SAMPLE_US) {
    lastUs = nowUs;

    int loP = digitalRead(LO_PLUS);
    int loM = digitalRead(LO_MINUS);

    bool leadsOff = (loP == 1) || (loM == 1);
    g_leadsOff = leadsOff;

    if (!leadsOff) {
      g_ecgRaw = analogRead(ECG_PIN);
    }

    // Debug to Serial (not too fast)
    static uint32_t lastPrint = 0;
    if (millis() - lastPrint >= 200) {
      lastPrint = millis();
      Serial.print("LeadsOff=");
      Serial.print(leadsOff);
      Serial.print("  ECG=");
      Serial.println(g_ecgRaw);
    }
  }
}
