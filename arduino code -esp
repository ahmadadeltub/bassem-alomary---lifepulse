#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <Adafruit_GFX.h>
#include <Adafruit_PCD8544.h>

// ================= WiFi / Telegram =================
const char* WIFI_SSID = "Ahmad";
const char* WIFI_PASS = "Tub01234";
const char* TG_TOKEN  = "8466468782:AAGJN7EE5mtZsluJo1Kqdgh8P4zbZ6zXj1E";
const char* TG_CHATID = "1337613901";

// ================= LCD =================
#define LCD_CLK 18
#define LCD_DIN 23
#define LCD_DC  19
#define LCD_CE  5
#define LCD_RST 14
#define LCD_BL  27
Adafruit_PCD8544 display(LCD_CLK, LCD_DIN, LCD_DC, LCD_CE, LCD_RST);

// ================= Heart Rate Sensor =================
#define HR_SENSOR_PIN 33

// ================= Outputs =================
#define GREEN_LED 13
#define RED_LED   12
#define BUZZER    26
#define HR_ALERT  100

// ================= Sampling =================
#define SAMPLE_RATE 500
unsigned long lastSample = 0;

// ================= HR =================
int bpm = 0;
unsigned long lastBeat = 0;
float smoothValue = 0;

// ================= ECG ENGINE (still running in background) =================
int ecgIndex = 0;
bool ecgActive = false;
int ecgHoldCounter = 0;
#define ECG_SPEED 3

// ================= Buzzer Pattern =================
unsigned long buzzerTimer = 0;
bool buzzerState = false;

bool alertSent = false;

// ================= Telegram =================
void sendTelegram(String msg) {
  WiFiClientSecure client;
  client.setInsecure();
  if (!client.connect("api.telegram.org", 443)) return;

  String payload = "chat_id=" + String(TG_CHATID) + "&text=" + msg;
  client.println("POST /bot" + String(TG_TOKEN) + "/sendMessage HTTP/1.1");
  client.println("Host: api.telegram.org");
  client.println("Content-Type: application/x-www-form-urlencoded");
  client.println("Content-Length: " + String(payload.length()));
  client.println();
  client.print(payload);
  client.stop();
}

// ================= Setup =================
void setup() {
  Serial.begin(115200);

  pinMode(HR_SENSOR_PIN, INPUT);
  pinMode(GREEN_LED, OUTPUT);
  pinMode(RED_LED, OUTPUT);
  pinMode(BUZZER, OUTPUT);
  pinMode(LCD_BL, OUTPUT);
  digitalWrite(LCD_BL, HIGH);

  analogReadResolution(12);
  analogSetPinAttenuation(HR_SENSOR_PIN, ADC_11db);

  display.begin();
  display.setContrast(60);
  display.setRotation(2);

  display.clearDisplay();
  display.setCursor(10, 18);
  display.print("Life Pulse");
  display.display();
  delay(2000);

  WiFi.begin(WIFI_SSID, WIFI_PASS);
  while (WiFi.status() != WL_CONNECTED) delay(300);
  sendTelegram("âœ… LifePulse Online");
}

// ================= Loop =================
void loop() {
  if (millis() - lastSample < (1000 / SAMPLE_RATE)) return;
  lastSample = millis();

  int raw = analogRead(HR_SENSOR_PIN);

  smoothValue = 0.85 * smoothValue + 0.15 * raw;
  int signal = (int)smoothValue;

  static int lastSignal = 0;
  static int threshold = 2000;
  bool beat = false;

  if (signal > threshold && lastSignal <= threshold) {
    unsigned long now = millis();
    if (now - lastBeat > 300) {
      bpm = 60000 / (now - lastBeat);
      lastBeat = now;
      beat = true;
    }
  }
  lastSignal = signal;

  // ===== OUTPUTS =====
  if (beat && bpm < HR_ALERT) tone(BUZZER, 1800, 40);

  if (bpm > HR_ALERT) {
    digitalWrite(GREEN_LED, LOW);
    digitalWrite(RED_LED, HIGH);

    // High beep â€“ pause â€“ high beep
    if (millis() - buzzerTimer >= 1000) {
      buzzerTimer = millis();
      buzzerState = !buzzerState;
      if (buzzerState) tone(BUZZER, 2500);
      else noTone(BUZZER);
    }

    if (!alertSent) {
      sendTelegram("ðŸš¨ HR ALERT\nHR: " + String(bpm));
      alertSent = true;
    }
  } else {
    digitalWrite(GREEN_LED, bpm > 0);
    digitalWrite(RED_LED, LOW);
    noTone(BUZZER);
    buzzerState = false;
    alertSent = false;
  }

  drawLCD();
}

// ================= LCD =================
void drawLCD() {
  display.clearDisplay();

  // ---- Title ----
  display.setCursor(16, 0);
  display.print("Life Pulse");

  // ---- Heart Rate (center) ----
  display.setTextSize(2);
  display.setCursor(18, 16);

  if (bpm > 0 && millis() - lastBeat < 3000) {
    display.print(bpm);
    display.print(" ");
  } else {
    display.print("-- ");
  }

  display.setTextSize(1);
  display.print("BPM");

  // ---- Status ----
  display.setCursor(10, 38);
  display.print("STATUS: ");

  if (millis() - lastBeat > 3000) {
    display.print("NO SIGNAL");
  } else if (bpm > HR_ALERT) {
    display.print("ALERT");
  } else {
    display.print("OK");
  }

  display.display();
}
